<div class="productos-container">
  <div class="page-header">
    <div class="header-content">
      <i class="fas fa-box" style="color: #DAA520; font-size: 2rem; margin-right: 1rem;"></i>
      <div>
        <h1 class="page-title">Productos</h1>
        <p class="page-subtitle">Gestión de inventario y catálogo</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn btn-primary" (click)="abrirModal()">
        <i class="fas fa-plus"></i>
        Nuevo Producto
      </button>
    </div>
  </div>

  <div class="content-section">
    @if (vistaPagina$ | async; as vista) {
      <div class="stats-grid">
        <div class="stat-card" [class.active]="(filterType()) === 'todos'" (click)="setFilterType('todos')" title="Ver todos">
          <div class="stat-icon">
            <i class="fas fa-boxes" style="color: #DAA520;"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.total }}</h3>
            <p>Total Productos</p>
          </div>
        </div>
        <div class="stat-card" [class.active]="(filterType()) === 'catalogo'" (click)="setFilterType('catalogo')" title="Solo productos en catálogo (no apartados ni vendidos)">
          <div class="stat-icon">
            <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.stats.enCatalogo }}</h3>
            <p>En catálogo</p>
          </div>
        </div>
        <div class="stat-card stat-apartados" [class.active]="(filterType()) === 'apartados'" (click)="setFilterType('apartados')" title="Solo apartados">
          <div class="stat-icon">
            <i class="fas fa-thumbtack" style="color: #FF9800;"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.stats.apartados }}</h3>
            <p>Apartados</p>
          </div>
        </div>
        <div class="stat-card stat-regalados" [class.active]="(filterType()) === 'regalados'" (click)="setFilterType('regalados')" title="Solo regalados">
          <div class="stat-icon">
            <i class="fas fa-gift"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.stats.regalados }}</h3>
            <p>Regalados</p>
          </div>
        </div>
        <div class="stat-card stat-pendientes" [class.active]="(filterType()) === 'pendientes-resena'" (click)="setFilterType('pendientes-resena')" title="Pendientes de reseñar">
          <div class="stat-icon">
            <i class="fas fa-pen-fancy"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.stats.pendientesResena }}</h3>
            <p>Pend. reseña</p>
          </div>
        </div>
        <div class="stat-card stat-rembolso" [class.active]="(filterType()) === 'pendientes-rembolso'" (click)="setFilterType('pendientes-rembolso')" title="Pendientes de rembolso">
          <div class="stat-icon">
            <i class="fas fa-undo"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.stats.pendientesRembolso }}</h3>
            <p>Pend. rembolso</p>
          </div>
        </div>
        <div class="stat-card stat-vendidos" [class.active]="(filterType()) === 'vendidos'" (click)="setFilterType('vendidos')" title="Solo vendidos">
          <div class="stat-icon">
            <i class="fas fa-hand-holding-usd"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.stats.vendidos }}</h3>
            <p>Vendidos</p>
          </div>
        </div>
        <div class="stat-card stat-devolucion" [class.active]="(filterType()) === 'con-devolucion'" (click)="setFilterType('con-devolucion')" title="Solo con devolución">
          <div class="stat-icon">
            <i class="fas fa-percentage"></i>
          </div>
          <div class="stat-info">
            <h3>{{ vista.stats.conDevolucion }}</h3>
            <p>Con devolución</p>
          </div>
        </div>
      </div>

      <div class="table-section" #tableSection>
        <div class="table-header table-header-fixed">
          <h2>Catálogo de Productos</h2>
          <div class="header-toolbar">
            <div class="search-box">
              <i class="fas fa-search"></i>
              <input type="text" placeholder="Buscar producto..." (input)="filtrarProductos($event)">
            </div>
            @if (vista.categoriasUnicas.length; as len) {
              <div class="filter-categoria-wrap">
                <label for="filterCategoria" class="filter-categoria-label">Categoría</label>
                <select
                  id="filterCategoria"
                  class="form-select form-select-sm filter-categoria-select"
                  [ngModel]="filterCategoria()"
                  (ngModelChange)="setFilterCategoria($event)">
                  <option value="">Todas</option>
                  @for (c of vista.categoriasUnicas; track c) {
                    <option [value]="c">{{ c }}</option>
                  }
                </select>
              </div>
            }
          </div>
        </div>

        <div class="table-body-scroll" #scrollContainer>
        @if (vista.totalFiltered === 0 && !searchTerm()) {
          <div class="empty-state">
            <i class="fas fa-box-open" style="color: #cbd5e1; font-size: 4rem; margin-bottom: 1rem;"></i>
            <p>No hay productos. Agrega el primero con «Nuevo Producto».</p>
          </div>
        }

        @if (vista.totalFiltered === 0 && searchTerm()) {
          <div class="empty-state">
            <i class="fas fa-search" style="color: #cbd5e1; font-size: 4rem; margin-bottom: 1rem;"></i>
            <p>No hay resultados para «{{ searchTerm() }}».</p>
          </div>
        }

        @if (vista.totalFiltered > 0) {
          <div class="table-responsive productos-table-wrapper">
            <table class="table table-striped table-hover table-bordered align-middle mb-0 table-sm productos-table">
              <thead class="productos-thead">
                <tr>
                  <th scope="col" class="text-center">Imagen</th>
                  <th scope="col" class="text-center">Producto</th>
                  <th scope="col" class="text-center">Categoría</th>
                  <th scope="col" class="text-center">Vendedor / Tienda</th>
                  <th scope="col" class="text-center">Precio compra</th>
                  <th scope="col" class="text-center" title="Dinero rembolsado">Rembolsado</th>
                  <th scope="col" class="text-center">Precio neto</th>
                  <th scope="col" class="text-center">Precio página</th>
                  <th scope="col" class="text-center">Ganancia · %</th>
                  <th scope="col" class="text-center">Estado</th>
                  <th scope="col" class="text-center">Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (p of vista.paginated; track p.id) {
                  <tr>
                    <td class="text-center">
                      @if (imagenPrincipal(p); as src) {
                        <img [src]="src" alt="" class="productos-thumb">
                      } @else {
                        <div class="productos-thumb-placeholder">
                          <i class="fas fa-image text-secondary"></i>
                        </div>
                      }
                    </td>
                    <td class="col-nombre">
                      <div class="col-nombre-inner">
                        @if (nombreMuyLargo(p.nombreProducto)) {
                          @if (isNombreExpandido(p.id)) {
                            <span class="col-nombre-texto"><strong>{{ p.nombreProducto }}</strong></span>
                            <button type="button" class="btn btn-sm btn-link btn-ver-mas p-0" (click)="toggleNombreExpandido(p.id)">Ver menos</button>
                          } @else {
                            <span class="col-nombre-texto"><strong>{{ truncateNombre(p.nombreProducto, maxNombreLength) }}...</strong></span>
                            <button type="button" class="btn btn-sm btn-link btn-ver-mas p-0" (click)="toggleNombreExpandido(p.id)">Ver más</button>
                          }
                        } @else {
                          <span class="col-nombre-texto"><strong>{{ p.nombreProducto }}</strong></span>
                        }
                      </div>
                    </td>
                    <td class="text-center"><span class="badge badge-categoria">{{ categoriaLabel(p.categoria) }}</span></td>
                    <td class="text-center small"><span>{{ p.nombreVendedor }}</span><span class="text-muted"> / {{ p.tienda }}</span></td>
                    <td class="text-center col-precio-compra">
                      @if (p.precioCompra != null) { ${{ p.precioCompra | number:'1.2-2' }} } @else { <span class="text-muted">—</span> }
                    </td>
                    <td class="text-center col-rembolsado">
                      @if (p.dineroRembolsado != null) { ${{ p.dineroRembolsado | number:'1.2-2' }} } @else { <span class="text-muted">—</span> }
                    </td>
                    <td class="text-center col-precio-neto">
                      @if (p.precioCompra != null || p.dineroRembolsado != null) {
                        ${{ ((p.precioCompra ?? 0) - (p.dineroRembolsado ?? 0)) | number:'1.2-2' }}
                      } @else { <span class="text-muted">—</span> }
                    </td>
                    <td class="text-center col-precio-pagina">
                      @if (p.precioPagina != null) { ${{ p.precioPagina | number:'1.2-2' }} } @else { <span class="text-muted">—</span> }
                    </td>
                    <td class="text-center col-ganancia" [class.ganancia-negativa]="((p.precioPagina ?? 0) - ((p.precioCompra ?? 0) - (p.dineroRembolsado ?? 0))) < 0">
                      @let precioNeto = (p.precioCompra ?? 0) - (p.dineroRembolsado ?? 0);
                      @let ganancia = (p.precioPagina ?? 0) - precioNeto;
                      @if (p.precioPagina != null) {
                        <span class="d-block">${{ ganancia | number:'1.2-2' }}</span>
                        @if (precioNeto !== 0) {
                          <span class="small">{{ (ganancia / precioNeto * 100) | number:'1.2-2' }}%</span>
                        } @else { <span class="text-muted">—</span> }
                      } @else { <span class="text-muted">—</span> }
                    </td>
                    <td class="text-center col-estado">
                      <span class="estado-badges">
                        @if (p.vendido) {
                          <span class="badge badge-estado badge-vendido">Vendido</span>
                        }
                        @if (p.apartado) {
                          <span class="badge badge-estado badge-apartado">Apartado</span>
                        }
                        @if (p.regalado) {
                          <span class="badge badge-estado badge-regalado">Regalado</span>
                        }
                        @if (!p.resenado) {
                          <span class="badge badge-estado badge-sin-resena">Sin reseña</span>
                        }
                        @if (p.resenado && (p.dineroRembolsado ?? 0) === 0) {
                          <span class="badge badge-estado badge-sin-rembolso">Sin rembolso</span>
                        }
                        @if (!p.vendido && !p.apartado && !p.regalado && (p.resenado && (p.dineroRembolsado ?? 0) !== 0)) {
                          <span class="badge badge-estado badge-disponible">Disponible</span>
                        }
                      </span>
                    </td>
                    <td class="text-center">
                      <div class="btn-group btn-group-sm productos-acciones">
                        <button type="button" class="btn btn-editar" title="Editar" (click)="editarProducto(p)"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn btn-eliminar" title="Eliminar" (click)="eliminarProducto(p.id!)"><i class="fas fa-trash"></i></button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
        </div>
      </div>

      @if (vista.totalFiltered > 0 && vista.totalPages > 1) {
        <div class="pagination-footer">
          <button type="button" class="pagination-btn" [disabled]="vista.currentPage <= 1" (click)="setPage(vista.currentPage - 1)" title="Anterior">
            <i class="fas fa-chevron-left"></i>
          </button>
          <span class="pagination-info">Página {{ vista.currentPage }} de {{ vista.totalPages }} ({{ vista.totalFiltered }} en total)</span>
          <button type="button" class="pagination-btn" [disabled]="vista.currentPage >= vista.totalPages" (click)="setPage(vista.currentPage + 1)" title="Siguiente">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      }
    }
  </div>
</div>

@if (saving()) {
  <app-spinner mode="overlay" message="Guardando producto..." size="lg"></app-spinner>
}
<app-producto-modal (productoGuardado)="guardarProducto($event)"></app-producto-modal>
<app-notification></app-notification>
